<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!-- 
<meta http-equiv="refresh" content="1">
 -->
<title>Tetris Battle</title>

<script type="text/javascript"
	src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
<script type="text/javascript"
	src="http://jquery-timer.googlecode.com/svn/trunk/jquery.timer.js"></script>

<script type="text/javascript">
jQuery(document).ready(
		function($) {
			$("#youlose").hide();
			
			$("#push_start").click(function(event) {
				event.stopPropagation();
				$.ajax({
				        type: "POST",
				        url: '/ddd-tetris/ws/playing',
				        contentType : 'application/json',
				        data: '',
				        success: function (data, textStatus, jqXHR) {
				        	var tetrisId = data;
				        	starting(tetrisId);
				        },
				        dataType : 'text'
		    		});
			});
			
			$("#join_battle").click(function(event) {
				event.stopPropagation();
				$.ajax({
				        type: "POST",
				        url: '/ddd-tetris/ws/playing',
				        contentType : 'application/json',
				        data: '',
				        success: function (data, textStatus, jqXHR) {
				        	var tetrisId = data;
				        	joinBattle(tetrisId);
				        },
				        dataType : 'text'
		    		});
			});

			var joinBattle = function(tetrisId) {
				$.ajax({
			        type: "POST",
			        url: '/ddd-tetris/ws/battles?tetrisId='+tetrisId,
			        contentType : 'application/json',
			        data: '',
			        success: function (data, textStatus, jqXHR) {
			        	var battleId = data;
			        	$("#battle_id").html(battleId);
			        	waitingStartBattle(battleId, tetrisId);
			        },
			        dataType : 'text'
	    		});
			}

			var waitingStartBattle = function(battleId, tetrisId) {
				var timer = $.timer(
						function() {
							$.get('/ddd-tetris/ws/battles/'+battleId)
							.done(function(data, textStatus, jqXHR) {
								var battle = data.battle;
								if (battle.status == 'AWAITED') {
									waitingStartBattle(battleId, tetrisId);
								} else {
									startingBattle(battleId, tetrisId);
								}
									
							})
							.fail(function(jqXHR, textStatus, errorThrown) { 
								alert('error'); 
							});
						},
						1000,
						false
					);
			    timer.once(1000);
			}

			var startingBattle = function(battleId, tetrisId) {
				$("#battle_id").html(battleId);
				starting(tetrisId);
			}
			
			var starting = function(tetrisId) {
				$.get('/ddd-tetris/ws/playing/'+tetrisId+'/start')
				.done(function(data, textStatus, jqXHR) {
					start(tetrisId);
				})
				.fail(function(jqXHR, textStatus, errorThrown) { 
					alert('error'); 
				});
			}

			var tetris;
			
			var refresh = function() {
				tetris.loadBoard();
				//tetris.loadScore();
			}
			
			var start = function(tetrisId) {
				
				$("#tetris_id").html(tetrisId);

				$('.result').empty();

				tetris = new Tetris(tetrisId);
				tetris.loadBoard();
				//tetris.loadScore();
				
				

				var timer = $.timer(
					function() {
						tetris.loadBoard();
						this.once(500);
					},
					500,
					false
				);

		        timer.once();

		        $(document).on("keydown",function(event) {
					if (event.which == 37){
						tetris.move('LEFT');
						event.stopPropagation();
	                } else if (event.which == 39) {
	                	tetris.move('RIGHT');
						event.stopPropagation();
	                } else if (event.which == 38) {
	                	tetris.rotate();
	                } else if (event.which == 40) {
	                	tetris.drop();
	                }         
	           });
			}
			
			var displayGrid = function(data) {
				var blocks = $('div.board table tr td');
				var grid = data.Result.grid;
				for(var i=0, height=grid.length; i < height; i++){
					for(var j=0, width=grid[i].item.length; j < width; j++){
						var index = i*10+j;
						var block = $(blocks[index]);
						var tetromino = grid[i].item[j];
						block.removeClass('IShape OShape TShape JShape lShape SShape ZShape PShape');
						if (tetromino) {
							block.addClass(tetromino+'Shape');
						}
					}
				}

				
				$("div.shape").hide();
				
				var piece = data.Result.piece;
				if (piece) {
					var currentPiece = $('#'+piece.tetromino+'Shape');
					// descente classique
					
					var y = piece.y * 23 + 46;
					var x = piece.x * 23 + 46;
					var rotation = piece.rotation * (90);
					currentPiece.css({ left: x+'px', top: y+'px', transform: 'rotate('+rotation+'deg)' });
					currentPiece.show();
					
				}

				displayScore(data.Result);
				
				if (data.Result.gameOver) {
					$("#youlose").show();
				}
			};

			var displayScore = function(data) {
				$('#score_level').html(data.score.level);
				$('#score_lines').html(data.score.lines);
				$('#score_points').html(data.score.points);
			}

			function Tetris(tetrisId) {
				this.tetrisId = tetrisId

				this.loadBoard = function() {
					$.get('/ddd-tetris/ws/playing/'+this.tetrisId+'/board')
					.done(function(data, textStatus, jqXHR) {
						displayGrid(data);
					})
					.fail(function(jqXHR, textStatus, errorThrown) { 
						alert('error');
					});
				}

				this.loadScore = function() {
					$.get('/ddd-tetris/ws/playing/'+this.tetrisId+'/score')
					.done(function(data, textStatus, jqXHR) {
						displayScore(data);
					})
					.fail(function(jqXHR, textStatus, errorThrown) { 
						alert('error'); 
					});
				}
        
		        this.move = function (direction) {
		        	$.ajax({
				        type: "POST",
				        url: '/ddd-tetris/ws/playing/'+this.tetrisId+'/move',
				        contentType : 'application/json',
				        data: '{ "move" : { "direction": '+direction+'}}',
				        success: function () {
				        	loadBoard();
				       }
		    		});
		        }
	        
	        	this.rotate = function () {
		        	$.ajax({
				        type: "POST",
				        url: '/ddd-tetris/ws/playing/'+this.tetrisId+'/rotate',
				        contentType : 'application/json',
				        data: '{ "rotate" : { "direction": RIGHT }}',
				        success: function () {
				        	loadBoard();
				       }
		    		});
	        	}

	        	this.drop = function () {
		        	$.ajax({
				        type: "POST",
				        url: '/ddd-tetris/ws/playing/'+this.tetrisId+'/drop',
				        contentType : 'application/json',
				        success: function () {
				        	loadBoard();
				       }
		    		});
	        	}
	        }
                
		}
);
</script>

<style type="text/css">
.square {
	background-color: black;
	border-color: gray;
	border-style: solid;
	border-width: thin;
	display: inline-block;
	height: 20px;
	width: 20px;
}

.breaker {
	display: block;
	clear: both;
}

.IShape {
	background-color: aqua;
}

.OShape {
	background-color: yellow;
}

.TShape {
	background-color: fuchsia;
}

.JShape {
	background-color: blue;
}

.LShape {
	background-color: orange;
}

.SShape {
	background-color: green;
}

.ZShape {
	background-color: red;
}

.PShape {
	background-color: gray;
}

.board {
	position: absolute;
	left: 50px;
	top: 50px;
	padding: 46px;
}

.board table {
	border-collapse: collapse;
}

.board td {
	height: 20px;
	width: 20px;
	border-color: gray;
	border-style: solid;
	border-width: thin;
}

.shape {
	position: absolute;
	top: 46px;
	left: 46px;
	transform-origin: 37.5% 37.5%;
}

.shape:hover {
	transform: rotate(90deg);
}

#IShape {
	top: 46px;
	left: 46px;
}

#TShape {
	top: 46px;
	left: 184px;
}

#LShape {
	top: 161px;
	left: 46px;
}

#JShape {
	top: 161px;
	left: 184px;
}

#ZShape {
	top: 276px;
	left: 46px;
	transform-origin: 50% 50%;
}

#SShape {
	top: 276px;
	left: 184px;
	transform-origin: 50% 50%;
}

#OShape {
	top: 391px;
	left: 115px;
}

.shape table {
	border-collapse: collapse;
}

div.shape td {
	height: 20px;
	width: 20px;
	border-color: transparent;
	border-style: solid;
	border-width: thin;
	text-align: center;
}

#gameover {
	color: red;
	font-style: oblique;
	font-weight: bold;
}

#youlose {
	position: absolute;
	left: 96px;
	top: 50px;
	color: red;
	font-style: italic;
	font-weight: bold;
	font-size: x-large;
	color: red;
	top: 50px;
}
</style>
</head>
<body>
	<div id="page-body">
		<div class="titre">
			TETRIS <span id="tetris_id"></span>
		</div>
		<div class="result">
			<a href="#" id="push_start">PUSH START</a> <a href="#"
				id="join_battle">JOIN BATTLE</a>
		</div>
		<div class="board">
			<table>
				<!-- 1 -->
				<tr>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
				<!-- 2 -->
				<tr>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
				<!-- 3 -->
				<tr>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
				<!-- 4 -->
				<tr>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
				<!-- 5 -->
				<tr>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
				<!-- 6 -->
				<tr>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
				<!-- 7 -->
				<tr>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
				<!-- 8 -->
				<tr>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
				<!-- 9 -->
				<tr>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
				<!-- 10 -->
				<tr>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
				<!-- 11 -->
				<tr>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
				<!-- 12 -->
				<tr>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
				<!-- 13 -->
				<tr>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
				<!-- 14 -->
				<tr>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
				<!-- 15 -->
				<tr>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
				<!-- 16 -->
				<tr>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
				<!-- 17 -->
				<tr>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
				<!-- 18 -->
				<tr>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
				<!-- 19 -->
				<tr>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
				<!-- 20 -->
				<tr>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
				<!-- 21 -->
				<tr>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
				<!-- 22 -->
				<tr>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>

			</table>
			<div id="IShape" class="shape">
				<table>
					<tr>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td class="IShape"></td>
						<td class="IShape"></td>
						<td class="IShape"></td>
						<td class="IShape"></td>
					</tr>
					<tr>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
				</table>
			</div>
			<div id="TShape" class="shape">
				<table>
					<tr>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td class="TShape"></td>
						<td class="TShape"></td>
						<td class="TShape"></td>
						<td></td>
					</tr>
					<tr>
						<td></td>
						<td class="TShape"></td>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
				</table>
			</div>
			<div id="LShape" class="shape rotate1">
				<table>
					<tr>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td class="LShape"></td>
						<td class="LShape"></td>
						<td class="LShape"></td>
						<td></td>
					</tr>
					<tr>
						<td class="LShape"></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
				</table>
			</div>
			<div id="JShape" class="shape">
				<table>
					<tr>
						<td class="JShape"></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td class="JShape"></td>
						<td class="JShape"></td>
						<td class="JShape"></td>
						<td></td>
					</tr>
					<tr>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
				</table>
			</div>
			<div id="ZShape" class="shape">
				<table>
					<tr>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td class="ZShape"></td>
						<td class="ZShape"></td>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td></td>
						<td class="ZShape"></td>
						<td class="ZShape"></td>
						<td></td>
					</tr>
					<tr>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
				</table>
			</div>
			<div id="SShape" class="shape">
				<table>
					<tr>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td></td>
						<td class="SShape"></td>
						<td class="SShape"></td>
						<td></td>
					</tr>
					<tr>
						<td class="SShape"></td>
						<td class="SShape"></td>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
				</table>
			</div>
			<div id="OShape" class="shape">
				<table>
					<tr>
						<td></td>
						<td class="OShape"></td>
						<td class="OShape"></td>
						<td></td>
					</tr>
					<tr>
						<td></td>
						<td class="OShape"></td>
						<td class="OShape"></td>
						<td></td>
					</tr>
					<tr>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
				</table>
			</div>
			<div id="youlose">You lose!</div>
			<div>
				<div>
					Level : <span id="score_level"></span>
				</div>
				<div>
					Lines : <span id="score_lines"></span>
				</div>
				<div>
					Score : <span id="score_points"></span>
				</div>
			</div>
		</div>
		<div class="battle">
			<div class="titre">
				BATTLE <span id="battle_id"></span>
			</div>
		</div>
	</div>
</body>
</html>